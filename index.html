<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>請求書PWA</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --border:#111; --card:#f6f6f6; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans JP", system-ui, -apple-system, sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    h1{font-size:18px;margin:0 0 10px;}
    .small{font-size:12px;color:var(--muted);line-height:1.55;}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px;}
    button{border:2px solid var(--border);background:#fff;padding:10px 12px;font-weight:900;border-radius:12px;cursor:pointer}
    button.primary{background:#111;color:#fff;}
    button.danger{border-color:#c00;color:#c00}
    .card{border:2px solid var(--border);border-radius:16px;padding:12px;background:#fff;margin:10px 0;}
    .sectionTitle{font-weight:900;margin:4px 0 10px;}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;}
    .row{display:grid;grid-template-columns: 130px 1fr; gap:10px; align-items:center;}
    .label{font-size:12px;color:var(--muted);font-weight:900;}
    input,textarea{
      width:100%; box-sizing:border-box;
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-size:16px;
      background:#fff;
    }
    input[readonly]{background:#f8f8f8}
    textarea{min-height:70px;resize:vertical;}
    .pill{display:inline-block;border:2px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:900;font-size:12px;background:var(--card)}
    .invoiceHeader{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:720px){ .row{grid-template-columns:1fr;} .two{grid-template-columns:1fr;} }
    .hr{height:1px;background:#ddd;margin:10px 0;}
    .moneyBox{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
    .moneyBox .m{border:2px solid #ddd;border-radius:12px;padding:8px;background:#fafafa}
    .moneyBox .t{font-size:11px;color:var(--muted);font-weight:900}
    .moneyBox .v{font-size:16px;font-weight:900;margin-top:3px}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; background:#111; color:#fff;
      padding:10px 12px; border-radius:999px;
      font-size:12px; font-weight:900;
      opacity:0; pointer-events:none; transition:opacity .2s;
      max-width:90vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show{opacity:1;}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
  </style>

  <!-- jsPDF (PDF生成) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>請求書PWA（請求先を縦に追加 → A4 PDF）</h1>
    <div class="small">
      ・請求日/振込期限は「共通項目」で1回だけ設定（全請求先で同一）。<br>
      ・「形式」は請求日の月から自動で <b>○月分</b> を表示します（編集不要）。<br>
      ・振込期限はカレンダー（date）から選択できます。<br>
      ・「PDFをまとめて作成」で、請求先ごとに1ページのA4 PDFを作成します。
    </div>

    <div class="bar">
      <button id="addBtn" class="primary">＋ 請求先カードを追加</button>
      <button id="saveBtn">入力を保存</button>
      <button id="loadBtn">保存を読み込み</button>
      <button id="clearBtn" class="danger">保存を消去</button>
    </div>

    <div class="card">
      <div class="sectionTitle">共通：自社情報</div>
      <div class="grid">
        <div class="row">
          <div class="label">発行元名</div>
          <input id="issuer_name" placeholder="例）VOUG" />
        </div>
        <div class="row">
          <div class="label">住所</div>
          <input id="issuer_addr" placeholder="例）札幌市西区…" />
        </div>
        <div class="two">
          <div class="row">
            <div class="label">TEL</div>
            <input id="issuer_tel" placeholder="例）011-xxx-xxxx" />
          </div>
          <div class="row">
            <div class="label">担当/連絡先</div>
            <input id="issuer_person" placeholder="例）担当 畑野千春 090-xxxx-xxxx" />
          </div>
        </div>
        <div class="row">
          <div class="label">メール</div>
          <input id="issuer_email" placeholder="例）xxx@example.com" />
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">共通：請求日 / 振込期限</div>
        <div class="two">
          <div class="row">
            <div class="label">請求日</div>
            <input id="common_issue_date" type="date" />
          </div>
          <div class="row">
            <div class="label">振込期限</div>
            <input id="common_due_date" type="date" />
          </div>
        </div>
        <div class="hint">※「形式」は請求日の月から自動表示（例：2月分）。</div>

        <div class="hr"></div>

        <div class="sectionTitle">共通：振込先</div>
        <div class="row">
          <div class="label">振込先（メイン）</div>
          <input id="bank_main" placeholder="例）○○銀行 ○○支店 普通 1234567 口座名…" />
        </div>
        <div class="row">
          <div class="label">予備口座</div>
          <input id="bank_sub" placeholder="例）○○銀行 ○○支店 普通 7654321 口座名…" />
        </div>
      </div>

      <div class="hint">
        ※ PDF生成は「jsPDF」をCDNで読み込みます。初回はオンラインで開いてください。
      </div>
    </div>

    <div id="invoices"></div>

    <div class="bar">
      <button id="pdfAllBtn" class="primary">PDFをまとめて作成（各請求先＝1ページ）</button>
    </div>

    <div class="small">
      iPhone保存：PDF作成後「共有」→「“ファイル”に保存」が確実です。<br>
      ※ iOSで「ファイルを直接開く」は挙動が不安定なので、GitHub Pages等で開くのが安定です。
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  // ===== PWA =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  const $ = (sel) => document.querySelector(sel);
  const invoicesEl = $('#invoices');
  const STORAGE_KEY = 'invoice_pwa_v4';

  const DEFAULT_COMMON = {
    issuer_name: 'VOUG',
    issuer_addr: '札幌市西区二十四軒２条２丁目４－２１ マンションニュー琴似１F B号',
    issuer_tel: '011-614-5286',
    issuer_person: '担当 畑野千春 090-7842-8798',
    issuer_email: 'voug286@gmeil.com',
    common_issue_date: '', // YYYY-MM-DD
    common_due_date: '',   // YYYY-MM-DD
    bank_main: '旭川信用金庫 本店 普通口座 1472165 口座名 有限会社ニューアロー',
    bank_sub: '楽天銀行 チェロ支店（214） 普通口座 1310243 口座名 ハタノチハル'
  };

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function monthLabelFromISO(iso){ // YYYY-MM-DD -> "2月分"
    if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
    const m = Number(iso.slice(5,7));
    if (!m) return '';
    return `${m}月分`;
  }

  function jpDateFromISO(iso){ // YYYY-MM-DD -> "YYYY.MM.DD"
    if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
    return iso.replaceAll('-', '.');
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, (c) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[c]);
  }

  function toast(msg){
    const el = $('#toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>el.classList.remove('show'), 1800);
  }

  function defaultInvoice(){
    return {
      customer: '',
      item_name: '',
      qty: 1,
      unit_price: 0,
      tax_rate: 0.10,
      remarks: ''
    };
  }

  function calc(inv){
    const qty = Number(inv.qty || 0);
    const unit = Number(inv.unit_price || 0);
    const rate = Number(inv.tax_rate ?? 0.10);
    const sub = qty * unit;
    const tax = Math.round(sub * rate);
    const total = sub + tax;
    return {sub, tax, total};
  }
  function fmtYen(n){ return Number(n||0).toLocaleString('ja-JP'); }

  let state = {
    common: {...DEFAULT_COMMON},
    invoices: [ defaultInvoice() ]
  };

  // 初期：請求日は今日をセット
  state.common.common_issue_date = todayISO();

  function readCommonFromUI(){
    state.common.issuer_name = $('#issuer_name').value.trim();
    state.common.issuer_addr = $('#issuer_addr').value.trim();
    state.common.issuer_tel = $('#issuer_tel').value.trim();
    state.common.issuer_person = $('#issuer_person').value.trim();
    state.common.issuer_email = $('#issuer_email').value.trim();
    state.common.common_issue_date = $('#common_issue_date').value.trim();
    state.common.common_due_date = $('#common_due_date').value.trim();
    state.common.bank_main = $('#bank_main').value.trim();
    state.common.bank_sub = $('#bank_sub').value.trim();
  }

  function writeCommonToUI(){
    $('#issuer_name').value = state.common.issuer_name ?? '';
    $('#issuer_addr').value = state.common.issuer_addr ?? '';
    $('#issuer_tel').value = state.common.issuer_tel ?? '';
    $('#issuer_person').value = state.common.issuer_person ?? '';
    $('#issuer_email').value = state.common.issuer_email ?? '';
    $('#common_issue_date').value = state.common.common_issue_date ?? '';
    $('#common_due_date').value = state.common.common_due_date ?? '';
    $('#bank_main').value = state.common.bank_main ?? '';
    $('#bank_sub').value = state.common.bank_sub ?? '';
  }

  function createCard(inv, idx){
    const c = document.createElement('div');
    c.className = 'card';
    c.dataset.idx = String(idx);
    const {sub, tax, total} = calc(inv);
    const formLabel = monthLabelFromISO(state.common.common_issue_date);

    c.innerHTML = `
      <div class="invoiceHeader">
        <div>
          <div class="pill">請求先 #${idx+1}</div>
          <div class="small" style="margin-top:6px;">このカード = PDF 1ページ</div>
        </div>
        <div class="bar" style="margin:0;">
          <button class="pdfBtn primary">この請求先のPDF</button>
          <button class="delBtn danger">削除</button>
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="row">
          <div class="label">宛名（請求先）</div>
          <input class="customer" value="${escapeHtml(inv.customer)}" placeholder="例）〇〇 様" />
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">明細（1行）</div>

        <div class="row">
          <div class="label">品名</div>
          <input class="item_name" value="${escapeHtml(inv.item_name)}" placeholder="例）D-1X" />
        </div>

        <div class="row">
          <div class="label">形式</div>
          <input class="item_form" value="${escapeHtml(formLabel)}" readonly />
        </div>

        <div class="two">
          <div class="row">
            <div class="label">数量</div>
            <input class="qty" inputmode="numeric" value="${escapeHtml(inv.qty)}" />
          </div>
          <div class="row">
            <div class="label">単価（円）</div>
            <input class="unit_price" inputmode="numeric" value="${escapeHtml(inv.unit_price)}" />
          </div>
        </div>

        <div class="row">
          <div class="label">税率</div>
          <input class="tax_rate" inputmode="decimal" value="${escapeHtml(inv.tax_rate)}" placeholder="0.10" />
        </div>

        <div class="moneyBox">
          <div class="m"><div class="t">小計</div><div class="v">¥${fmtYen(sub)}</div></div>
          <div class="m"><div class="t">消費税</div><div class="v">¥${fmtYen(tax)}</div></div>
          <div class="m"><div class="t">合計</div><div class="v">¥${fmtYen(total)}</div></div>
        </div>

        <div class="row">
          <div class="label">備考</div>
          <textarea class="remarks" placeholder="自由記載">${escapeHtml(inv.remarks)}</textarea>
        </div>
      </div>
    `;

    const bind = (cls, key, parser = (v)=>v) => {
      const el = c.querySelector(cls);
      el.addEventListener('input', () => {
        const i = Number(c.dataset.idx);
        state.invoices[i][key] = parser(el.value);
        refreshCardMoney(c, state.invoices[i]);
      });
    };

    bind('.customer','customer',(v)=>v);
    bind('.item_name','item_name',(v)=>v);
    bind('.qty','qty',(v)=>Number(v||0));
    bind('.unit_price','unit_price',(v)=>Number(v||0));
    bind('.tax_rate','tax_rate',(v)=>Number(v||0));
    bind('.remarks','remarks',(v)=>v);

    c.querySelector('.delBtn').addEventListener('click', () => {
      const i = Number(c.dataset.idx);
      state.invoices.splice(i,1);
      if (state.invoices.length === 0) state.invoices.push(defaultInvoice());
      render();
      toast('削除しました');
    });

    c.querySelector('.pdfBtn').addEventListener('click', async () => {
      readCommonFromUI();
      const i = Number(c.dataset.idx);
      await generatePdf([state.invoices[i]]);
    });

    return c;
  }

  function refreshCardMoney(cardEl, inv){
    const {sub,tax,total} = calc(inv);
    const v = cardEl.querySelectorAll('.moneyBox .v');
    if (v && v.length === 3){
      v[0].textContent = `¥${fmtYen(sub)}`;
      v[1].textContent = `¥${fmtYen(tax)}`;
      v[2].textContent = `¥${fmtYen(total)}`;
    }
  }

  function render(){
    invoicesEl.innerHTML = '';
    state.invoices.forEach((inv, idx) => {
      invoicesEl.appendChild(createCard(inv, idx));
    });
  }

  function updateAllFormLabels(){
    // 請求日の月変更に合わせて、表示だけ更新
    document.querySelectorAll('.item_form').forEach(el => {
      el.value = monthLabelFromISO(state.common.common_issue_date);
    });
  }

  function save(){
    readCommonFromUI();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    toast('保存しました');
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw){ toast('保存データがありません'); return; }
    try{
      const obj = JSON.parse(raw);
      if (obj && obj.common && Array.isArray(obj.invoices)){
        state = obj;
        if (!state.common.common_issue_date) state.common.common_issue_date = todayISO();
        writeCommonToUI();
        render();
        toast('読み込みました');
      }else{
        toast('保存データ形式が不正です');
      }
    }catch(e){
      toast('読み込みに失敗しました');
    }
  }

  function clearSaved(){
    localStorage.removeItem(STORAGE_KEY);
    toast('保存を消去しました');
  }

  // ===== PDF生成（A4, 1請求先=1ページ）=====
  async function generatePdf(invoices){
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF){
      alert('PDFライブラリ(jsPDF)が読み込めていません。最初はオンラインで開いてください。');
      return;
    }

    const doc = new jsPDF({ unit:'mm', format:'a4' });
    const margin = 12;
    const pageW = 210;
    const pageH = 297;

    const common = state.common;
    const issueDateJP = jpDateFromISO(common.common_issue_date || '');
    const dueDateJP = jpDateFromISO(common.common_due_date || '');
    const formLabel = monthLabelFromISO(common.common_issue_date || '');

    invoices.forEach((inv, pageIndex) => {
      if (pageIndex > 0) doc.addPage();

      const {sub, tax, total} = calc(inv);

      // タイトル
      doc.setFont('helvetica','bold');
      doc.setFontSize(18);
      doc.text('請 求 書', pageW - margin - 40, margin + 6);

      // 宛名
      doc.setFontSize(14);
      doc.text(`${inv.customer || '（宛名未設定）'}`, margin, margin + 18);
      doc.setLineWidth(0.4);
      doc.line(margin, margin + 20, pageW - margin, margin + 20);

      // 発行元（右）
      doc.setFontSize(9);
      doc.setFont('helvetica','normal');
      let y = margin + 16;
      const rightX = pageW - margin;
      const r = (t)=>{ if(t) { doc.text(t, rightX, y, {align:'right'}); y += 4.2; } };
      r(common.issuer_name || '');
      r(common.issuer_addr || '');
      r(common.issuer_tel ? `TEL ${common.issuer_tel}` : '');
      r(common.issuer_person || '');
      r(common.issuer_email || '');

      // 日付/期限（共通）
      doc.setFontSize(10);
      doc.text(`請求日：${issueDateJP || ''}`, margin, margin + 28);
      if (dueDateJP) doc.text(`振込期限：${dueDateJP}`, margin, margin + 34);

      // 明細テーブル
      const tableTop = margin + 42;
      const colX = [margin, 92, 120, 150, pageW - margin]; // 5列
      const rowH = 9;

      // ヘッダ枠
      doc.setLineWidth(0.2);
      doc.rect(margin, tableTop, pageW - margin*2, rowH);
      doc.line(colX[1], tableTop, colX[1], tableTop + rowH);
      doc.line(colX[2], tableTop, colX[2], tableTop + rowH);
      doc.line(colX[3], tableTop, colX[3], tableTop + rowH);

      doc.setFont('helvetica','bold');
      doc.setFontSize(10);
      doc.text('品名', colX[0] + 2, tableTop + 6);
      doc.text('形式', colX[1] + 2, tableTop + 6);
      doc.text('数量', colX[2] + 2, tableTop + 6);
      doc.text('単価', colX[3] + 2, tableTop + 6);

      // 1行目
      const bodyTop = tableTop + rowH;
      doc.setFont('helvetica','normal');
      doc.rect(margin, bodyTop, pageW - margin*2, rowH);
      doc.line(colX[1], bodyTop, colX[1], bodyTop + rowH);
      doc.line(colX[2], bodyTop, colX[2], bodyTop + rowH);
      doc.line(colX[3], bodyTop, colX[3], bodyTop + rowH);

      doc.text(inv.item_name || '', colX[0] + 2, bodyTop + 6);
      doc.text(formLabel || '', colX[1] + 2, bodyTop + 6);
      doc.text(String(inv.qty ?? ''), colX[2] + 2, bodyTop + 6);
      doc.text(`${fmtYen(inv.unit_price || 0)}円`, colX[4] - 2, bodyTop + 6, {align:'right'});

      // 金額欄（右下）
      const boxW = 70;
      const boxX = pageW - margin - boxW;
      let boxY = bodyTop + rowH + 8;

      const line = (label, value) => {
        doc.setFont('helvetica','normal');
        doc.setFontSize(10);
        doc.text(label, boxX, boxY);
        doc.setFont('helvetica','bold');
        doc.text(value, boxX + boxW, boxY, {align:'right'});
        boxY += 7;
      };

      line('小計', `¥${fmtYen(sub)}`);
      line('消費税', `¥${fmtYen(tax)}`);
      doc.setLineWidth(0.2);
      doc.line(boxX, boxY-4, boxX + boxW, boxY-4);
      line('合計', `¥${fmtYen(total)}`);

      // 振込先
      let bY = pageH - margin - 44;
      doc.setFont('helvetica','bold');
      doc.setFontSize(10);
      doc.text('振込先', margin, bY);
      doc.setFont('helvetica','normal');
      doc.setFontSize(9);
      bY += 5;
      if (common.bank_main) doc.text(common.bank_main, margin, bY);
      bY += 5;
      if (common.bank_sub) doc.text(common.bank_sub, margin, bY);

      // 備考
      let rmY = pageH - margin - 22;
      doc.setFont('helvetica','bold');
      doc.setFontSize(10);
      doc.text('備考', margin, rmY);
      doc.setFont('helvetica','normal');
      doc.setFontSize(9);
      const remarks = (inv.remarks || '').trim();
      if (remarks){
        const lines = doc.splitTextToSize(remarks, pageW - margin*2);
        doc.text(lines, margin, rmY + 5);
      }
    });

    const filename = `invoice_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(filename);
    toast('PDFを作成しました（保存/共有してください）');
  }

  // ===== イベント =====
  $('#addBtn').addEventListener('click', () => {
    state.invoices.push(defaultInvoice());
    render();
    toast('請求先カードを追加しました');
  });
  $('#saveBtn').addEventListener('click', save);
  $('#loadBtn').addEventListener('click', load);
  $('#clearBtn').addEventListener('click', clearSaved);
  $('#pdfAllBtn').addEventListener('click', async () => {
    readCommonFromUI();
    await generatePdf(state.invoices);
  });

  // 共通欄：変更は即 state へ反映（PDF/形式へ反映）
  ['issuer_name','issuer_addr','issuer_tel','issuer_person','issuer_email','bank_main','bank_sub']
    .forEach(id => $('#'+id).addEventListener('input', () => readCommonFromUI()));

  // 請求日変更 → 形式（○月分）を全カードに反映
  $('#common_issue_date').addEventListener('change', () => {
    readCommonFromUI();
    updateAllFormLabels();
  });
  $('#common_due_date').addEventListener('change', () => readCommonFromUI());

  // 初期表示
  writeCommonToUI();
  render();
</script>
</body>
</html>
