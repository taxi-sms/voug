<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>請求書PWA（完全同一レイアウト版）</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />

  <!-- 画面表示フォント（PDFはキャンバス化するので日本語OK） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --border:#111; --card:#f6f6f6; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans JP", system-ui, -apple-system, sans-serif;overflow-x:hidden;}
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    h1{font-size:18px;margin:0 0 10px;}
    .small{font-size:12px;color:var(--muted);line-height:1.55;}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px;}
    button{border:2px solid var(--border);background:#fff;padding:10px 12px;font-weight:900;border-radius:12px;cursor:pointer}
    button.primary{background:#111;color:#fff;}
    button.danger{border-color:#c00;color:#c00}
    .card{border:2px solid var(--border);border-radius:16px;padding:12px;background:#fff;margin:10px 0;}
    .sectionTitle{font-weight:900;margin:4px 0 10px;}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;}
    .row{display:grid;grid-template-columns: 130px 1fr; gap:10px; align-items:center;}
    .label{font-size:12px;color:var(--muted);font-weight:900;}
    input,textarea{
      width:100%; box-sizing:border-box;
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-size:16px;
      background:#fff;
    }
    input[readonly]{background:#f8f8f8}
    textarea{min-height:70px;resize:vertical;}
    .pill{display:inline-block;border:2px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:900;font-size:12px;background:var(--card)}
    .invoiceHeader{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:720px){ .row{grid-template-columns:1fr;} .two{grid-template-columns:1fr;} }
    .hr{height:1px;background:#ddd;margin:10px 0;}
    .moneyBox{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
    .moneyBox .m{border:2px solid #ddd;border-radius:12px;padding:8px;background:#fafafa}
    .moneyBox .t{font-size:11px;color:var(--muted);font-weight:900}
    .moneyBox .v{font-size:16px;font-weight:900;margin-top:3px}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; background:#111; color:#fff;
      padding:10px 12px; border-radius:999px;
      font-size:12px; font-weight:900;
      opacity:0; pointer-events:none; transition:opacity .2s;
      max-width:90vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      z-index:9999;
    }
    .toast.show{opacity:1;}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    /* ===== A4請求書（PDF化対象） ===== */
    .a4stage{position:fixed; left:0; top:0; width:210mm; height:297mm; background:#fff; opacity:0; pointer-events:none; transform:translateX(-200vw); }
    .a4{isolation:isolate; contain:layout paint;
      width:210mm; height:297mm; background:#fff;
      box-sizing:border-box;
      padding:12mm;
      color:#000;
      font-family:"Noto Sans JP", sans-serif;
    }
    .a4 .invTitle{
      position:absolute;
      top:12mm;
      right:12mm;
      font-size:18pt;
      font-weight:900;
      letter-spacing:2px;
    }
    .a4 .customer{
      position:absolute;
      top:22mm;
      left:12mm;
      font-size:14pt;
      font-weight:700;
      padding-bottom:2mm;
      width:120mm;
      border-bottom:1px solid #000;
    }
    .a4 .issuer{
      position:absolute;
      top:24mm;
      right:12mm;
      width:80mm;
      text-align:right;
      font-size:9pt;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .a4 .dates{
      position:absolute;
      top:38mm;
      left:12mm;
      font-size:10pt;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .a4 .table{
      position:absolute;
      top:52mm;
      left:12mm;
      right:12mm;
      border:1px solid #000;
      border-collapse:collapse;
      font-size:10pt;
      width:calc(210mm - 24mm);
      table-layout:fixed;
    }
    .a4 .table th,.a4 .table td{
      border:1px solid #000;
      padding:2.2mm 2mm;
      vertical-align:middle;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .a4 .table th{font-weight:900; background:#fff;}
    .a4 .alignR{text-align:right}
    .a4 .alignC{text-align:center}

    .a4 .summary{
      position:absolute;
      top:78mm;
      right:12mm;
      width:70mm;
      font-size:10pt;
      line-height:1.6;
    }
    .a4 .summaryRow{
      display:flex;
      justify-content:space-between;
      gap:6mm;
    }
    .a4 .summaryRow .k{font-weight:700}
    .a4 .summaryRow .v{font-weight:900}
    .a4 .summaryLine{
      height:0;
      border-top:1px solid #000;
      margin:1mm 0 1mm 0;
    }

    .a4 .bankTitle{
      position:absolute;
      bottom:40mm;
      left:12mm;
      font-size:10pt;
      font-weight:900;
    }
    .a4 .bankText{
      position:absolute;
      bottom:24mm;
      left:12mm;
      right:12mm;
      font-size:9pt;
      line-height:1.45;
      white-space:pre-wrap;
    }
    .a4 .remarkTitle{
      position:absolute;
      bottom:18mm;
      left:12mm;
      font-size:10pt;
      font-weight:900;
    }
    .a4 .remarkText{
      position:absolute;
      bottom:8mm;
      left:12mm;
      right:12mm;
      font-size:9pt;
      line-height:1.45;
      white-space:pre-wrap;
    }
  </style>

  <!-- PDF生成：HTMLをキャンバス化 → PDFへ貼り付け（日本語フォント問題ゼロ） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>請求書PWA（完全同一レイアウト / 日本語OK）</h1>
    <div class="small">
      ・PDFは「画面の請求書をそのまま画像化してA4に貼る」方式なので、日本語が絶対に崩れません。<br>
      ・初回はオンラインで開いてください（ライブラリCDN読み込み）。
    </div>

    <div class="bar">
      <button id="addBtn" class="primary">＋ 請求先カードを追加</button>
      <button id="saveBtn">入力を保存</button>
      <button id="loadBtn">保存を読み込み</button>
      <button id="clearBtn" class="danger">保存を消去</button>
    </div>

    <div class="card">
      <div class="sectionTitle">共通：自社情報</div>
      <div class="grid">
        <div class="row"><div class="label">発行元名</div><input id="issuer_name" /></div>
        <div class="row"><div class="label">住所</div><input id="issuer_addr" /></div>
        <div class="two">
          <div class="row"><div class="label">TEL</div><input id="issuer_tel" /></div>
          <div class="row"><div class="label">担当/連絡先</div><input id="issuer_person" /></div>
        </div>
        <div class="row"><div class="label">メール</div><input id="issuer_email" /></div>

        <div class="hr"></div>

        <div class="sectionTitle">共通：請求日 / 振込期限</div>
        <div class="two">
          <div class="row"><div class="label">請求日</div><input id="common_issue_date" type="date" /></div>
          <div class="row"><div class="label">振込期限</div><input id="common_due_date" type="date" /></div>
        </div>
        <div class="hint">※ 形式は請求日の月から自動で「○月分」になります。</div>

        <div class="hr"></div>

        <div class="sectionTitle">共通：振込先</div>
        <div class="row"><div class="label">振込先（メイン）</div><input id="bank_main" /></div>
        <div class="row"><div class="label">予備口座</div><input id="bank_sub" /></div>
      </div>
    </div>

    <div id="invoices"></div>

    <div class="bar">
      <button id="pdfAllBtn" class="primary">PDFをまとめて作成（各請求先＝1ページ）</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- PDF化用のA4ステージ（画面外） -->
  <div class="a4stage" aria-hidden="true">
    <div id="a4" class="a4">
      <div class="invTitle">請 求 書</div>
      <div id="p_customer" class="customer"></div>
      <div id="p_issuer" class="issuer"></div>
      <div id="p_dates" class="dates"></div>

      <table class="table">
        <colgroup>
          <col style="width:42%">
          <col style="width:20%">
          <col style="width:13%">
          <col style="width:25%">
        </colgroup>
        <thead>
          <tr>
            <th>品名</th>
            <th>形式</th>
            <th class="alignC">数量</th>
            <th class="alignR">単価</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="p_item_name"></td>
            <td id="p_item_form"></td>
            <td id="p_qty" class="alignC"></td>
            <td id="p_unit" class="alignR"></td>
          </tr>
        </tbody>
      </table>

      <div class="summary">
        <div class="summaryRow"><span class="k">小計</span><span id="p_sub" class="v"></span></div>
        <div class="summaryRow"><span class="k">消費税</span><span id="p_tax" class="v"></span></div>
        <div class="summaryLine"></div>
        <div class="summaryRow"><span class="k">合計</span><span id="p_total" class="v"></span></div>
      </div>

      <div class="bankTitle">振込先</div>
      <div id="p_bank" class="bankText"></div>

      <div class="remarkTitle">備考</div>
      <div id="p_remark" class="remarkText"></div>
    </div>
  </div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
  }

  const $ = (s)=>document.querySelector(s);
  const invoicesEl = $('#invoices');
  const STORAGE_KEY = 'invoice_pwa_htmlpdf_v1';

  const DEFAULT_COMMON = {
    issuer_name: 'VOUG',
    issuer_addr: '札幌市西区二十四軒２条２丁目４－２１ マンションニュー琴似１F B号',
    issuer_tel: '011-614-5286',
    issuer_person: '担当 畑野千春 090-7842-8798',
    issuer_email: 'voug286@gmeil.com',
    common_issue_date: '',
    common_due_date: '',
    bank_main: '旭川信用金庫 本店 普通口座 1472165 口座名 有限会社ニューアロー',
    bank_sub: '楽天銀行 チェロ支店（214） 普通口座 1310243 口座名 ハタノチハル'
  };

  function todayISO(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function jpDate(iso){ return (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) ? iso.replaceAll('-','.') : ''; }
  function monthLabel(iso){
    if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
    const m = Number(iso.slice(5,7)); return m ? `${m}月分` : '';
  }
  function fmtYen(n){ return Number(n||0).toLocaleString('ja-JP'); }
  function calc(inv){
    const qty=Number(inv.qty||0), unit=Number(inv.unit_price||0), rate=Number(inv.tax_rate??0.10);
    const sub=qty*unit; const tax=Math.round(sub*rate); const total=sub+tax;
    return {sub,tax,total};
  }
  function toast(msg){
    const el=$('#toast'); el.textContent=msg; el.classList.add('show');
    clearTimeout(window.__toastTimer);
    window.__toastTimer=setTimeout(()=>el.classList.remove('show'),1800);
  }

  function defaultInvoice(){
    return { customer:'', item_name:'', qty:1, unit_price:0, tax_rate:0.10, remarks:'' };
  }

  let state = { common:{...DEFAULT_COMMON}, invoices:[defaultInvoice()] };
  state.common.common_issue_date = todayISO();

  function readCommonFromUI(){
    state.common.issuer_name=$('#issuer_name').value.trim();
    state.common.issuer_addr=$('#issuer_addr').value.trim();
    state.common.issuer_tel=$('#issuer_tel').value.trim();
    state.common.issuer_person=$('#issuer_person').value.trim();
    state.common.issuer_email=$('#issuer_email').value.trim();
    state.common.common_issue_date=$('#common_issue_date').value.trim();
    state.common.common_due_date=$('#common_due_date').value.trim();
    state.common.bank_main=$('#bank_main').value.trim();
    state.common.bank_sub=$('#bank_sub').value.trim();
  }
  function writeCommonToUI(){
    $('#issuer_name').value=state.common.issuer_name||'';
    $('#issuer_addr').value=state.common.issuer_addr||'';
    $('#issuer_tel').value=state.common.issuer_tel||'';
    $('#issuer_person').value=state.common.issuer_person||'';
    $('#issuer_email').value=state.common.issuer_email||'';
    $('#common_issue_date').value=state.common.common_issue_date||'';
    $('#common_due_date').value=state.common.common_due_date||'';
    $('#bank_main').value=state.common.bank_main||'';
    $('#bank_sub').value=state.common.bank_sub||'';
  }

  function createCard(inv, idx){
    const c=document.createElement('div');
    c.className='card'; c.dataset.idx=String(idx);
    const {sub,tax,total}=calc(inv);
    const form=monthLabel(state.common.common_issue_date);

    c.innerHTML = `
      <div class="invoiceHeader">
        <div>
          <div class="pill">請求先 #${idx+1}</div>
          <div class="small" style="margin-top:6px;">このカード = PDF 1ページ</div>
        </div>
        <div class="bar" style="margin:0;">
          <button class="pdfBtn primary">この請求先のPDF</button>
          <button class="delBtn danger">削除</button>
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="row"><div class="label">宛名（請求先）</div><input class="customer" value="${escapeHtml(inv.customer)}" placeholder="例）のみくい処 旨や 様" /></div>

        <div class="hr"></div>
        <div class="sectionTitle">明細（1行）</div>

        <div class="row"><div class="label">品名</div><input class="item_name" value="${escapeHtml(inv.item_name)}" placeholder="例）D-1X" /></div>
        <div class="row"><div class="label">形式</div><input class="item_form" value="${escapeHtml(form)}" readonly /></div>

        <div class="two">
          <div class="row"><div class="label">数量</div><input class="qty" inputmode="numeric" value="${escapeHtml(inv.qty)}" /></div>
          <div class="row"><div class="label">単価（円）</div><input class="unit_price" inputmode="numeric" value="${escapeHtml(inv.unit_price)}" /></div>
        </div>

        <div class="row"><div class="label">税率</div><input class="tax_rate" inputmode="decimal" value="${escapeHtml(inv.tax_rate)}" placeholder="0.10" /></div>

        <div class="moneyBox">
          <div class="m"><div class="t">小計</div><div class="v">¥${fmtYen(sub)}</div></div>
          <div class="m"><div class="t">消費税</div><div class="v">¥${fmtYen(tax)}</div></div>
          <div class="m"><div class="t">合計</div><div class="v">¥${fmtYen(total)}</div></div>
        </div>

        <div class="row"><div class="label">備考</div><textarea class="remarks" placeholder="自由記載">${escapeHtml(inv.remarks)}</textarea></div>
      </div>
    `;

    const bind = (sel,key,parser=(v)=>v)=>{
      const el=c.querySelector(sel);
      el.addEventListener('input',()=>{
        const i=Number(c.dataset.idx);
        state.invoices[i][key]=parser(el.value);
        refreshMoney(c,state.invoices[i]);
      });
    };
    bind('.customer','customer',(v)=>v);
    bind('.item_name','item_name',(v)=>v);
    bind('.qty','qty',(v)=>Number(v||0));
    bind('.unit_price','unit_price',(v)=>Number(v||0));
    bind('.tax_rate','tax_rate',(v)=>Number(v||0));
    bind('.remarks','remarks',(v)=>v);

    c.querySelector('.delBtn').addEventListener('click',()=>{
      const i=Number(c.dataset.idx);
      state.invoices.splice(i,1);
      if(state.invoices.length===0) state.invoices.push(defaultInvoice());
      render(); toast('削除しました');
    });

    c.querySelector('.pdfBtn').addEventListener('click',async()=>{
      readCommonFromUI();
      const i=Number(c.dataset.idx);
      await generatePdf([state.invoices[i]]);
    });

    return c;
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, (c) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[c]);
  }
  function refreshMoney(card,inv){
    const {sub,tax,total}=calc(inv);
    const v=card.querySelectorAll('.moneyBox .v');
    if(v.length===3){ v[0].textContent=`¥${fmtYen(sub)}`; v[1].textContent=`¥${fmtYen(tax)}`; v[2].textContent=`¥${fmtYen(total)}`; }
  }
  function render(){
    invoicesEl.innerHTML='';
    state.invoices.forEach((inv,idx)=>invoicesEl.appendChild(createCard(inv,idx)));
  }
  function updateAllFormLabels(){
    document.querySelectorAll('.item_form').forEach(el=>el.value=monthLabel(state.common.common_issue_date));
  }

  function save(){
    readCommonFromUI();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    toast('保存しました');
  }
  function load(){
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){ toast('保存データがありません'); return; }
    try{
      const obj=JSON.parse(raw);
      if(obj && obj.common && Array.isArray(obj.invoices)){
        state=obj;
        if(!state.common.common_issue_date) state.common.common_issue_date=todayISO();
        writeCommonToUI(); render(); toast('読み込みました');
      }else toast('保存データ形式が不正です');
    }catch(e){ toast('読み込みに失敗しました'); }
  }
  function clearSaved(){ localStorage.removeItem(STORAGE_KEY); toast('保存を消去しました'); }

  // ===== PDF生成（A4 / 完全同一レイアウト）=====
  async function renderA4(inv){
    const common=state.common;
    const form=monthLabel(common.common_issue_date);
    const issue=jpDate(common.common_issue_date);
    const due=jpDate(common.common_due_date);

    // 文字（最初のPDFの見え方に合わせて整形）
    $('#p_customer').textContent = inv.customer || '（宛名未設定）';
    $('#p_issuer').textContent =
      `${common.issuer_name || ''}\n${common.issuer_addr || ''}\n` +
      `${common.issuer_tel ? 'TEL ' + common.issuer_tel : ''}\n` +
      `${common.issuer_person || ''}\n${common.issuer_email || ''}`.trim();

    let dateLines = '';
    if (issue) dateLines += `請求日：${issue}\n`;
    if (due) dateLines += `振込期限：${due}`;
    $('#p_dates').textContent = dateLines.trim();

    $('#p_item_name').textContent = inv.item_name || '';
    $('#p_item_form').textContent = form || '';
    $('#p_qty').textContent = String(inv.qty ?? '');
    $('#p_unit').textContent = `${fmtYen(inv.unit_price || 0)}円`;

    const {sub,tax,total}=calc(inv);
    $('#p_sub').textContent = `¥${fmtYen(sub)}`;
    $('#p_tax').textContent = `¥${fmtYen(tax)}`;
    $('#p_total').textContent = `¥${fmtYen(total)}`;

    const bank = [common.bank_main, common.bank_sub].filter(Boolean).join('\n');
    $('#p_bank').textContent = bank;

    $('#p_remark').textContent = (inv.remarks || '').trim();

    // フォント読み込み待ち（Google Fonts）
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch(_){}
    }
  }

  async function a4ToCanvas(){
    const a4 = document.getElementById('a4');
    // scale を上げると印刷が綺麗（重くなるので2で妥協）
    return await html2canvas(a4, {
      backgroundColor:'#ffffff',
      scale: 2,
      useCORS: true
    });
  }

  async function generatePdf(invoices){
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF || !window.html2canvas){
      alert('PDFライブラリが読み込めていません。最初はオンラインで開いてください。');
      return;
    }
    const doc = new jsPDF({unit:'mm', format:'a4'});

    for(let i=0;i<invoices.length;i++){
      if(i>0) doc.addPage();

      toast(`PDF生成中… ${i+1}/${invoices.length}`);
      await renderA4(invoices[i]);

      const canvas = await a4ToCanvas();
      const imgData = canvas.toDataURL('image/jpeg', 0.92);

      // A4にぴったり貼る
      doc.addImage(imgData, 'JPEG', 0, 0, 210, 297);
    }

    const filename = `invoice_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(filename);
    toast('PDFを作成しました');
  }

  // ===== イベント =====
  $('#addBtn').addEventListener('click',()=>{ state.invoices.push(defaultInvoice()); render(); toast('請求先カードを追加しました'); });
  $('#saveBtn').addEventListener('click',save);
  $('#loadBtn').addEventListener('click',load);
  $('#clearBtn').addEventListener('click',clearSaved);
  $('#pdfAllBtn').addEventListener('click',async()=>{ readCommonFromUI(); await generatePdf(state.invoices); });

  ['issuer_name','issuer_addr','issuer_tel','issuer_person','issuer_email','bank_main','bank_sub']
    .forEach(id => $('#'+id).addEventListener('input',()=>readCommonFromUI()));
  $('#common_issue_date').addEventListener('change',()=>{ readCommonFromUI(); updateAllFormLabels(); });
  $('#common_due_date').addEventListener('change',()=>readCommonFromUI());

  // 初期表示
  writeCommonToUI();
  render();
</script>
</body>
</html>
